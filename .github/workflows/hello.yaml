name: Just test

on: 
  push:
  workflow_dispatch:
    inputs:
      prebuild:
        description: Pre-build skipping tests (true|false)
        default: 'false'
      mavenFlags:
        description: Maven flags
        default: -P integration
      openposeContainerPort:
        description: OpenPose container port
        required: true
        default: 5002
      storyId:
        description: Story ID (e.g. 1234)
        required: true

jobs:
  something_to_test:
    runs-on: ubuntu-latest
    env:
      COMMIT_PREFIX: ''
      PR_BODY_STORY_TEXT: ''
      PR_COMMIT_MESSAGE: |
        [ch${{ github.event.inputs.storyId }}] Update snapshots (automated commit)
        Generated by [${{ github.action }} run nr. ${{ github.run_number }}](https://github.com/${{github.repository}}/actions/runs/${{ github.run_id }})

        ${{ github.event.inputs.comment }}

        Pre-build skipping tests: ${{ contains(github.event.inputs.prebuild, 'true') }}
        Maven flags: ${{ github.event.inputs.mavenFlags }}
      PR_COMMITTER: '${{ github.actor }} <admin+devOps@amb-technology.ai>'
      PR_BRANCH: '${{ env.BRANCH_NAME }}_update-snapshots_${{ github.run_number }}'
      PR_TITLE: '[Bot] Update snapshots by ${{ github.action }} ${{ github.run_number }}'
      PR_BODY: |
        Generated by [${{ github.action }} run nr. ${{ github.run_number }}](https://github.com/${{github.repository}}/actions/runs/${{ github.run_id }})

        Associated with [ch${{ github.event.inputs.storyId }}]

        ${{ github.event.inputs.comment }}

        Pre-build skipping tests: ${{ contains(github.event.inputs.prebuild, 'true') }}
        Maven flags: ${{ github.event.inputs.mavenFlags }}
     

    steps:
      - name: Log inputs
        run: |
          echo "
            Pre-build skipping tests: ${{ contains(github.event.inputs.prebuild, 'true') }}
            Maven flags: ${{ github.event.inputs.mavenFlags }}
            OpenPose container port: ${{ github.event.inputs.openposeContainerPort }}
            Story ID: ${{ github.event.inputs.storyId }}
          "

      # compute inputs
      - name: Set AIST_OPENPOSE_API_ORIGIN
        if: github.event.inputs.storyId
        run: echo "AIST_OPENPOSE_API_ORIGIN=http://aist-openpose-api:${{ github.event.inputs.openposeContainerPort }}" >> $GITHUB_ENV
      - name: Set COMMIT_PREFIX
        if: github.event.inputs.storyId
        run: echo "COMMIT_PREFIX=[${{ github.event.inputs.storyId }}] " >> $GITHUB_ENV
      - name: Set PR body text
        if: github.event.inputs.storyId
        run: echo "PR_BODY_STORY_TEXT=Associated with [${{ github.event.inputs.storyId }}]" >> $GITHUB_ENV
      - name: Verify Maven flags
        continue-on-error: true
        if: github.event.inputs.mavenFlags
        run: echo ${{ github.event.inputs.mavenFlags }}
      - name: Set SHORT_COMMIT_SHA
        run: |
          sha=${{ github.sha }}
          echo "SHORT_COMMIT_SHA=${sha:0:8}" >> $GITHUB_ENV

      - name: echo action url
        run: echo "https://github.com/${{github.repository}}/actions/runs/${{ github.run_id }}"
      - name: Get branch name
        uses: nelonoel/branch-name@v1.0.1
      - name: Set BRANCH_NAME
        uses: nelonoel/branch-name@v1.0.1

